<!DOCTYPE html>
<html>
<head>
  <title></title>
  <style type="text/css">
    html { height: 100% }
    body { height: 100%; margin: 0; padding: 0 }
    #map-canvas { height: 100% }
  </style>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4du1SngujDMVsO91yl14Q5rzmQp7eytM"></script>
  <script type="text/javascript">
    $(function() {
      var mapOptions = {
        center: new google.maps.LatLng(-34.397, 150.644),
        zoom: 8
      };
      var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
      var geocoder = new google.maps.Geocoder();

      var geocode = function(latLng) {
        var extractComponent = function(address_components, type) {
          return _.find(address_components, function(comp) {
            return _.contains(comp.types, type)
          });
        };

        geocoder.geocode({ latLng: latLng }, function(results, status) {

          var addressComponents = _.first(results).address_components;
          var country = extractComponent(addressComponents, 'country');
          var town = extractComponent(addressComponents, 'locality');

          console.log("(", latLng.lat, ",", latLng.lng, ") = ", town.long_name + ",", country.long_name)
        });
      };

      var generateStaticMapUrl = function(points) {
        var ptToStr = function(pt) {
          return pt.lat + ',' + pt.lng;
        };

        var url = "http://maps.googleapis.com/maps/api/staticmap?";
        var center = ptToStr(_.last(points));
        var path = _.last(points, 30).map(ptToStr).join('|');

        var params = {
          center: center,
          markers: 'color:red|' + center,
          path: 'color:red|' + path,
          zoom: 14,
          scale: 2,
          size: '278x200',
          maptype: 'terrain',
          key: 'AIzaSyB4du1SngujDMVsO91yl14Q5rzmQp7eytM'
        };

        return url + $.param(params)
      };

      var reducePoints = function(points) {
        return _.filter(points, function(pt, i) {
          return i % 3 == 0;
        });
      };

      var plot = function(points) {
        var poly = new google.maps.Polyline({
          path: points,
          geodesic: false,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
        poly.setMap(map);
      };

      $.ajax({
        url: '/points.json'
      }).done(function(points) {
        map.setCenter(_.last(points));
        geocode(_.last(points));
        plot(reducePoints(points));
        console.log(generateStaticMapUrl(reducePoints(points)));
      }).fail(function() {
        console.log('fail', arguments)
      });
    });
  </script>
</head>
<body>
  <div id="map-canvas"/>
</body>
</html>